name: Build Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows .exe
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flet
    
    - name: Build Windows executable
      run: |
        flet build windows
      env:
        PYTHONIOENCODING: utf-8
    
    - name: Find executable and prepare package
      shell: pwsh
      run: |
        Write-Host "=== Searching for .exe files ==="
        $allExes = Get-ChildItem -Path build -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
        if ($allExes) {
          Write-Host "Found $($allExes.Count) executable(s):"
          $allExes | ForEach-Object { 
            Write-Host "  $($_.FullName) (Size: $([math]::Round($_.Length/1MB, 2)) MB)"
          }
          
          $releaseExe = $allExes | Where-Object { $_.DirectoryName -like "*Release*" } | Select-Object -First 1
          if (-not $releaseExe) {
            $releaseExe = $allExes | Where-Object { $_.DirectoryName -like "*runner*" } | Select-Object -First 1
          }
          if (-not $releaseExe) {
            $releaseExe = $allExes | Select-Object -First 1
          }
          
          if ($releaseExe) {
            Write-Host "`nUsing executable: $($releaseExe.FullName)"
            $exeDir = $releaseExe.DirectoryName
            $packageDir = "package"
            New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
            
            Write-Host "Copying executable..."
            Copy-Item $releaseExe.FullName -Destination "$packageDir\$($releaseExe.Name)" -Force
            
            Write-Host "Copying all DLL files from $exeDir..."
            $dlls = Get-ChildItem -Path $exeDir -Filter "*.dll" -ErrorAction SilentlyContinue
            if ($dlls) {
              Write-Host "Found $($dlls.Count) DLL file(s):"
              $dlls | ForEach-Object {
                Copy-Item $_.FullName -Destination "$packageDir\$($_.Name)" -Force
                Write-Host "  Copied: $($_.Name)"
              }
            } else {
              Write-Host "WARNING: No DLL files found in $exeDir"
            }
            
            Write-Host "Searching for DLL files in parent directories..."
            $parentDir = Split-Path $exeDir -Parent
            $allDlls = Get-ChildItem -Path $parentDir -Recurse -Filter "*.dll" -ErrorAction SilentlyContinue | Where-Object { $_.DirectoryName -ne $exeDir }
            if ($allDlls) {
              Write-Host "Found $($allDlls.Count) additional DLL file(s):"
              $allDlls | ForEach-Object {
                $destPath = "$packageDir\$($_.Name)"
                if (-not (Test-Path $destPath)) {
                  Copy-Item $_.FullName -Destination $destPath -Force
                  Write-Host "  Copied: $($_.Name) from $($_.DirectoryName)"
                }
              }
            }
            
            Write-Host "Copying data directory if exists..."
            $dataDir = Join-Path $exeDir "data"
            if (Test-Path $dataDir) {
              Copy-Item -Path $dataDir -Destination "$packageDir\data" -Recurse -Force
              Write-Host "  Copied data directory"
            }
            
            Write-Host "`nPackage prepared in: $packageDir"
            Get-ChildItem -Path $packageDir | ForEach-Object { Write-Host "  $($_.Name) ($([math]::Round($_.Length/1KB, 2)) KB)" }
          } else {
            Write-Host "ERROR: Could not find executable"
            exit 1
          }
        } else {
          Write-Host "ERROR: No .exe files found in build directory"
          Write-Host "`nBuild directory structure:"
          Get-ChildItem -Path build -Recurse -Directory | Select-Object -First 30 | ForEach-Object { Write-Host "  $($_.FullName)" }
          exit 1
        }
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-exe
        path: |
          package/*.exe
          package/*.dll
          package/data/**
        if-no-files-found: error
        retention-days: 30

  build-linux-rpm:
    name: Build Linux .rpm (Fedora)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build RPM in Fedora container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          fedora:latest bash -c "
          dnf install -y rpm-build python3-devel python3-pip git
          python3 -m pip install --upgrade pip
          pip3 install briefcase flet
          briefcase create || true
          briefcase build || briefcase build linux || true
          briefcase package --format rpm || briefcase package linux --format rpm || true
          "
    
    - name: Upload Linux RPM artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-rpm
        path: dist/*.rpm
        if-no-files-found: warn
        retention-days: 30

  build-linux-deb:
    name: Build Linux .deb (Ubuntu/Debian)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3-dev python3-venv
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase flet
    
    - name: Create briefcase project
      run: |
        briefcase create || true
    
    - name: Build Linux .deb package
      run: |
        briefcase build || briefcase build linux || true
        briefcase package --format deb || briefcase package linux --format deb || true
    
    - name: Upload Linux DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-deb
        path: dist/*.deb
        if-no-files-found: warn
        retention-days: 30

